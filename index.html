<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Je Parle English | Premium ESL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        blue: { 900: '#1e3a8a', 950: '#0f172a' },
                        gold: { 300: '#fcd34d', 500: '#fbbf24', 600: '#d97706' }
                    },
                    fontFamily: {
                        cinzel: ['Cinzel', 'serif'],
                        lato: ['Lato', 'sans-serif']
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'pulse-gold': 'pulseGold 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'flip': 'flip 0.6s ease-out forwards',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        pulseGold: {
                            '0%, 100%': { opacity: 1, boxShadow: '0 0 15px #fcd34d' },
                            '50%': { opacity: .7, boxShadow: '0 0 5px #fcd34d' },
                        },
                        flip: {
                            '0%': { transform: 'rotateY(0deg)' },
                            '100%': { transform: 'rotateY(180deg)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Lato', sans-serif; background: radial-gradient(circle at center, #1e3a8a 0%, #0f172a 100%); color: white; min-height: 100vh; overflow-x: hidden; }
        h1, h2, h3, h4, h5, .font-cinzel { font-family: 'Cinzel', serif; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-gold { background: rgba(251, 191, 36, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(251, 191, 36, 0.4); }
        .text-gold-gradient { background: linear-gradient(to right, #fcd34d, #fbbf24); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .bg-gold-gradient { background: linear-gradient(to right, #fcd34d, #fbbf24); }
        
        /* Hide Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: #fbbf24; border-radius: 4px; }
        
        /* Flashcard Flip */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; transition: transform 0.6s; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        /* Custom Inputs */
        input[type="text"], textarea { background: rgba(255,255,255,0.1); border: 1px solid rgba(251, 191, 36, 0.5); color: white; padding: 0.75rem; border-radius: 0.5rem; outline: none; width: 100%; transition: all 0.3s;}
        input[type="text"]:focus, textarea:focus { border-color: #fcd34d; box-shadow: 0 0 10px rgba(251, 191, 36, 0.5); background: rgba(255,255,255,0.15); }
        
        .tab-btn { transition: all 0.3s ease; white-space: nowrap; }
        .tab-btn.active { background: linear-gradient(to right, #fcd34d, #fbbf24); color: #0f172a; font-weight: bold; border-color: transparent; box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); }
        .tab-btn:not(.active):hover { background: rgba(255,255,255,0.1); border-color: #fcd34d; }

        canvas { display: block; margin: 0 auto; max-width: 100%; border-radius: 8px; border: 2px solid #fbbf24; background: rgba(0,0,0,0.3); }
        
        /* Toast */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 8px; color: white; font-weight: bold; animation: float 3s ease-in-out infinite; backdrop-filter: blur(5px); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .toast.success { background: rgba(16, 185, 129, 0.8); border: 1px solid #10b981; }
        .toast.error { background: rgba(239, 68, 68, 0.8); border: 1px solid #ef4444; }
    </style>
</head>
<body class="flex flex-col">

    <!-- Navbar -->
    <header class="glass sticky top-0 z-50 p-4 border-b-2 border-gold-500/50">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-2xl md:text-3xl text-gold-gradient font-bold drop-shadow-lg flex items-center gap-2">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                Je Parle English
            </h1>
            <nav id="tabs-container" class="flex overflow-x-auto w-full md:w-auto pb-2 md:pb-0 gap-2 hide-scrollbar">
                <!-- Tabs injected by JS -->
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl w-full mx-auto p-4 md:p-8 flex flex-col gap-6" id="app-content">
        <!-- Content injected by JS -->
    </main>

    <!-- Footer -->
    <footer class="glass p-6 text-center text-sm text-gray-400 border-t border-white/10 mt-auto">
        <p>Made with ❤️ for learners. &copy; 2026 Je Parle English.</p>
    </footer>

    <!-- Toast Notifications -->
    <div id="toast-container"></div>

    <script>
        // ==========================================
        // 1. DATA & CONTENT COMPRESSION
        // ==========================================
        // Compressed format to fit 500+ words within limits. Format: "En|Fr|Sentence^En|Fr|Sentence"
        const rawVocab = {
            "Family & People": "Mother|Mère|My mother is kind.^Father|Père|His father works hard.^Brother|Frère|I have one brother.^Sister|Sœur|Her sister is tall.^Grandmother|Grand-mère|My grandmother bakes cakes.^Grandfather|Grand-père|He lives with his grandfather.^Aunt|Tante|My aunt lives in Paris.^Uncle|Oncle|My uncle has a car.^Cousin|Cousin(e)|We played with our cousin.^Friend|Ami(e)|She is my best friend.^Man|Homme|The man is reading.^Woman|Femme|The woman is walking.^Boy|Garçon|The boy is running.^Girl|Fille|The girl is smiling.^Baby|Bébé|The baby is sleeping.^Child|Enfant|The child plays outside.^Parents|Parents|My parents love me.^Wife|Épouse|His wife is a doctor.^Husband|Mari|Her husband is a teacher.^Family|Famille|We have a big family.",
            "Food & Drink": "Apple|Pomme|I eat a red apple.^Banana|Banane|She likes bananas.^Bread|Pain|We buy fresh bread.^Water|Eau|Drink a glass of water.^Milk|Lait|Cats love milk.^Cheese|Fromage|France has good cheese.^Meat|Viande|He cooks the meat.^Fish|Poisson|The fish swims fast.^Chicken|Poulet|We had chicken for dinner.^Egg|Œuf|I ate an egg for breakfast.^Rice|Riz|They eat rice everyday.^Pasta|Pâtes|I cook pasta with tomato.^Soup|Soupe|The soup is hot.^Salad|Salade|She ordered a green salad.^Fruit|Fruit|Apples are a fruit.^Vegetable|Légume|Carrots are a vegetable.^Cake|Gâteau|It is a chocolate cake.^Coffee|Café|He drinks coffee in the morning.^Tea|Thé|I prefer green tea.^Juice|Jus|Apple juice is sweet.",
            "Travel & Places": "Airport|Aéroport|We go to the airport.^Train|Train|The train is fast.^Bus|Bus|I take the bus to school.^Car|Voiture|She drives a blue car.^Bicycle|Vélo|He rides his bicycle.^Ticket|Billet|Buy a ticket here.^Hotel|Hôtel|The hotel is beautiful.^Map|Carte|Look at the map.^Passport|Passeport|Don't forget your passport.^Luggage|Bagages|My luggage is heavy.^City|Ville|Paris is a big city.^Country|Pays|Canada is a cold country.^Street|Rue|Walk down this street.^Station|Gare|The train leaves the station.^Beach|Plage|We swim at the beach.^Mountain|Montagne|They climb the mountain.^Island|Île|The island is beautiful.^Bridge|Pont|Cross the long bridge.^Park|Parc|Children play in the park.^Restaurant|Restaurant|We eat at a restaurant.",
            "Work & School": "Teacher|Professeur|The teacher explains the lesson.^Student|Étudiant|The student reads a book.^School|École|I go to school everyday.^Classroom|Classe|The classroom is large.^Book|Livre|Read this interesting book.^Pen|Stylo|Write with a blue pen.^Pencil|Crayon|Draw with a pencil.^Paper|Papier|I need a piece of paper.^Desk|Bureau|Sit at your desk.^Computer|Ordinateur|Type on the computer.^Job|Travail|He has a new job.^Office|Bureau|She works in an office.^Boss|Patron|My boss is nice.^Worker|Ouvrier|The worker builds houses.^Doctor|Médecin|The doctor helps people.^Nurse|Infirmière|The nurse is kind.^Police|Police|Call the police.^Money|Argent|I save my money.^Meeting|Réunion|The meeting starts now.^Learn|Apprendre|We learn English today.",
            "Animals": "Dog|Chien|The dog barks loudly.^Cat|Chat|The cat sleeps all day.^Bird|Oiseau|The bird flies high.^Fish|Poisson|The fish swims in the sea.^Horse|Cheval|He rides a brown horse.^Cow|Vache|The cow gives milk.^Pig|Cochon|The pig is pink.^Sheep|Mouton|The sheep has soft wool.^Mouse|Souris|The cat caught a mouse.^Elephant|Éléphant|The elephant is huge.^Lion|Lion|The lion is the king.^Tiger|Tigre|The tiger has stripes.^Bear|Ours|The bear eats honey.^Monkey|Singe|The monkey climbs trees.^Snake|Serpent|The snake is long.^Rabbit|Lapin|The rabbit hops fast.^Duck|Canard|The duck swims in the pond.^Frog|Grenouille|The frog jumps high.^Turtle|Tortue|The turtle walks slowly.^Spider|Araignée|The spider makes a web.",
            "Clothes": "Shirt|Chemise|He wears a white shirt.^Pants|Pantalon|My pants are blue.^Dress|Robe|She bought a red dress.^Skirt|Jupe|The skirt is too short.^Jacket|Veste|Put on your jacket.^Coat|Manteau|It is cold, wear a coat.^Shoes|Chaussures|Take off your shoes.^Socks|Chaussettes|My socks are warm.^Hat|Chapeau|The sun is hot, wear a hat.^Gloves|Gants|Wear gloves in winter.^Scarf|Écharpe|Wrap the scarf around your neck.^Belt|Ceinture|Fasten your belt.^Tie|Cravate|He wears a suit and tie.^Suit|Costume|The businessman wears a suit.^Glasses|Lunettes|I need my glasses to read.^Ring|Bague|She wears a gold ring.^Watch|Montre|Look at your watch.^Umbrella|Parapluie|Take an umbrella, it rains.^Boots|Bottes|Wear your winter boots.^T-shirt|T-shirt|He wears a casual t-shirt.",
            "Body & Health": "Head|Tête|My head hurts.^Hair|Cheveux|She has long hair.^Face|Visage|Wash your face.^Eye|Œil|Close your left eye.^Ear|Oreille|I hear with my ears.^Nose|Nez|He has a small nose.^Mouth|Bouche|Open your mouth.^Tooth|Dent|Brush your teeth.^Neck|Cou|She wears a necklace around her neck.^Shoulder|Épaule|My shoulder aches.^Arm|Bras|Raise your right arm.^Hand|Main|Wash your hands.^Finger|Doigt|He points with his finger.^Leg|Jambe|My legs are tired.^Foot|Pied|My left foot hurts.^Back|Dos|Keep your back straight.^Stomach|Estomac|My stomach is full.^Heart|Cœur|My heart beats fast.^Blood|Sang|Blood is red.^Medicine|Médicament|Take your medicine.",
            "House & Furniture": "House|Maison|We live in a big house.^Door|Porte|Close the front door.^Window|Fenêtre|Open the window.^Room|Pièce|This room is cold.^Bedroom|Chambre|I sleep in my bedroom.^Kitchen|Cuisine|We cook in the kitchen.^Bathroom|Salle de bain|Wash your hands in the bathroom.^Living room|Salon|Watch TV in the living room.^Garden|Jardin|Flowers grow in the garden.^Wall|Mur|The wall is painted white.^Floor|Sol|Sweep the floor.^Roof|Toit|The house has a red roof.^Bed|Lit|The bed is soft.^Chair|Chaise|Sit on the chair.^Table|Table|Put the book on the table.^Sofa|Canapé|Relax on the sofa.^Lamp|Lampe|Turn on the lamp.^Mirror|Miroir|Look in the mirror.^Clock|Horloge|The clock shows the time.^Key|Clé|Lock the door with a key.",
            "Nature & Weather": "Sun|Soleil|The sun is shining.^Moon|Lune|The moon is bright tonight.^Star|Étoile|Look at the stars.^Sky|Ciel|The sky is blue.^Cloud|Nuage|There is a dark cloud.^Rain|Pluie|The rain is falling.^Snow|Neige|Children play in the snow.^Wind|Vent|The wind blows hard.^Storm|Tempête|A storm is coming.^Fire|Feu|The fire is hot.^Water|Eau|The water is cold.^Sea|Mer|Swim in the sea.^Ocean|Océan|The ocean is deep.^River|Rivière|The river flows fast.^Lake|Lac|We fish in the lake.^Tree|Arbre|The tree has green leaves.^Flower|Fleur|The flower smells nice.^Grass|Herbe|Sit on the green grass.^Earth|Terre|We live on Earth.^World|Monde|The world is big.",
            "Technology": "Phone|Téléphone|Answer your phone.^Computer|Ordinateur|Turn on the computer.^Screen|Écran|Look at the screen.^Keyboard|Clavier|Type on the keyboard.^Mouse|Souris|Click the mouse.^Internet|Internet|Browse the internet.^Website|Site web|Visit our website.^Email|E-mail|Send me an email.^Message|Message|I received a message.^App|Application|Download this app.^Game|Jeu|Play a video game.^Music|Musique|Listen to music.^Video|Vidéo|Watch a funny video.^Camera|Appareil photo|Take a picture with the camera.^Battery|Batterie|My battery is low.^Charge|Charger|Charge your phone.^Cable|Câble|Plug in the cable.^Button|Bouton|Press the red button.^Password|Mot de passe|Enter your password.^File|Fichier|Save the file."
        };

        // Parse raw string into usable arrays
        let vocabulary = {};
        for (const [theme, dataStr] of Object.entries(rawVocab)) {
            vocabulary[theme] = dataStr.split('^').map(item => {
                const [en, fr, sentence] = item.split('|');
                return { en, fr, sentence };
            });
        }

        // Story Data
        const storyData = {
            title: "The Golden Journey",
            text: "Once upon a time, a young boy named Leo lived in a small village near a huge mountain. Every day, he walked to the school with his best friend, a little dog. One morning, the weather was beautiful. The sun was shining in the blue sky. While walking, Leo found a shiny gold coin on the street. He picked it up and put it in his pocket. He decided to buy a fresh apple and some bread at the market. After eating his delicious food, he felt very happy. He looked at the high mountain and promised himself to climb it one day.",
            paragraphs: [
                "Once upon a time, a young boy named Leo lived in a small village near a huge mountain. Every day, he walked to the school with his best friend, a little dog.",
                "One morning, the weather was beautiful. The sun was shining in the blue sky. While walking, Leo found a shiny gold coin on the street. He picked it up and put it in his pocket.",
                "He decided to buy a fresh apple and some bread at the market. After eating his delicious food, he felt very happy. He looked at the high mountain and promised himself to climb it one day."
            ]
        };

        const quizData = [
            { q: "Where did Leo live?", opts: ["In a big city", "In a small village", "On a boat", "In a forest"], ans: 1 },
            { q: "What was near the village?", opts: ["An ocean", "A desert", "A huge mountain", "A deep lake"], ans: 2 },
            { q: "Who did Leo walk to school with?", opts: ["His mother", "His brother", "A little dog", "A cat"], ans: 2 },
            { q: "How was the weather?", opts: ["Raining", "Snowing", "Cloudy", "Beautiful and sunny"], ans: 3 },
            { q: "What did Leo find on the street?", opts: ["A red apple", "A silver key", "A shiny gold coin", "A map"], ans: 2 },
            { q: "Where did he put the coin?", opts: ["In his bag", "In his pocket", "In his shoe", "He threw it"], ans: 1 },
            { q: "What did he decide to buy?", opts: ["A new book", "An apple and bread", "A toy", "Some milk"], ans: 1 },
            { q: "Where did he buy the food?", opts: ["At the school", "At the hotel", "At the market", "At the airport"], ans: 2 },
            { q: "How did he feel after eating?", opts: ["Sad", "Tired", "Angry", "Very happy"], ans: 3 },
            { q: "What did he promise himself?", opts: ["To buy a house", "To climb the mountain", "To find more coins", "To sleep"], ans: 1 }
        ];

        const sentencesData = [
            "The dog barks loudly.", "She likes bananas.", "I go to school everyday.", "The sun is shining.", "Wash your hands.",
            "Put on your jacket.", "We buy fresh bread.", "He drives a blue car.", "Read this interesting book.", "Look at the stars.",
            "The train is fast.", "I eat a red apple.", "The room is cold.", "Children play in the park.", "We learn English today."
        ];

        const clozeData = [
            { text: "The ___ is shining in the blue ___.", blanks: ["sun", "sky"], bank: ["sun", "moon", "sky", "water"] },
            { text: "I eat a red ___ and some fresh ___.", blanks: ["apple", "bread"], bank: ["car", "apple", "bread", "shoe"] },
            { text: "He rides a brown ___ in the green ___.", blanks: ["horse", "grass"], bank: ["horse", "fish", "grass", "cloud"] },
            { text: "She wears a white ___ and blue ___.", blanks: ["shirt", "pants"], bank: ["shirt", "pants", "tree", "book"] },
            { text: "The train leaves the ___ very ___.", blanks: ["station", "fast"], bank: ["station", "slowly", "fast", "apple"] },
            { text: "We live in a big ___ with a red ___.", blanks: ["house", "roof"], bank: ["house", "dog", "roof", "sea"] }
        ];

        const wordsData = ["apple", "brother", "mountain", "computer", "elephant", "yellow", "window", "kitchen", "school", "weather", "beautiful", "morning", "pocket", "market", "promise", "village", "friend", "happy", "shiny", "street"];

        const grammarData = [
            { s: "Leo walked to the school.", past: "walked", present: ["walk", "walking", "walks"], ans: 0 },
            { s: "He found a shiny gold coin.", past: "found", present: ["finds", "find", "finding"], ans: 1 },
            { s: "She bought a red dress.", past: "bought", present: ["buy", "buys", "buying"], ans: 0 },
            { s: "The dog slept all day.", past: "slept", present: ["sleep", "sleeping", "sleeps"], ans: 0 },
            { s: "They ate fresh bread.", past: "ate", present: ["eat", "eating", "eats"], ans: 0 },
            { s: "I went to the airport.", past: "went", present: ["go", "going", "goes"], ans: 0 },
            { s: "He took the bus.", past: "took", present: ["take", "taking", "takes"], ans: 0 },
            { s: "We saw a big bird.", past: "saw", present: ["seeing", "sees", "see"], ans: 2 }
        ];

        const speakingPrompts = [
            { p: "Talk about your best friend.", q: ["Who are they?", "How did you meet?", "What do you do together?"] },
            { p: "Describe your favorite food.", q: ["What is it?", "How does it taste?", "When do you eat it?"] },
            { p: "Talk about a place you want to travel to.", q: ["Where is it?", "Why do you want to go there?", "Who will you go with?"] },
            { p: "Describe your daily morning routine.", q: ["What time do you wake up?", "What is the first thing you do?", "What do you eat for breakfast?"] },
            { p: "Talk about your favorite hobby.", q: ["What is it?", "How often do you do it?", "Why do you like it?"] }
        ];

        // ==========================================
        // 2. STATE MANAGEMENT & AUDIO ENGINE
        // ==========================================
        const State = {
            activeTab: 'Flashcards',
            flashcardTheme: 'Family & People',
            flashcardIndex: 0,
            scores: JSON.parse(localStorage.getItem('esl_scores')) || { quiz: 0, game: 0 },
            customWords: [],
            tabs: ['Flashcards', 'Reading', 'Story Quiz', 'Sentences', 'Fill Blanks', 'Words', 'Grammar', 'Dictation', 'Speaking', 'Writing', 'Game', 'Leaderboard']
        };

        const AudioEngine = {
            ctx: null,
            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },
            playTone(freq, type, duration, vol = 0.1) {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            click() { this.init(); this.playTone(600, 'sine', 0.1, 0.05); },
            correct() { this.init(); this.playTone(800, 'sine', 0.1, 0.1); setTimeout(() => this.playTone(1200, 'sine', 0.2, 0.1), 100); },
            wrong() { this.init(); this.playTone(300, 'square', 0.2, 0.1); setTimeout(() => this.playTone(200, 'square', 0.3, 0.1), 150); },
            win() { 
                this.init(); 
                [400, 500, 600, 800].forEach((f, i) => {
                    setTimeout(() => this.playTone(f, 'sine', 0.2, 0.1), i * 150);
                });
            }
        };

        const Toast = {
            show(msg, type = 'success') {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = `toast ${type}`;
                el.innerText = msg;
                container.appendChild(el);
                setTimeout(() => el.remove(), 3000);
            }
        };

        const saveScore = (key, val) => {
            State.scores[key] = Math.max(State.scores[key] || 0, val);
            localStorage.setItem('esl_scores', JSON.stringify(State.scores));
        };

        // ==========================================
        // 3. UI RENDERING CORE
        // ==========================================
        const UI = {
            init() {
                this.renderNav();
                this.renderContent();
                // Initialize audio on first user interaction
                document.body.addEventListener('click', () => AudioEngine.init(), {once: true});
            },
            renderNav() {
                const container = document.getElementById('tabs-container');
                container.innerHTML = State.tabs.map(tab => `
                    <button onclick="UI.switchTab('${tab}')" 
                        class="tab-btn px-4 py-2 rounded-full border border-white/20 text-sm md:text-base glass ${State.activeTab === tab ? 'active' : ''}">
                        ${tab}
                    </button>
                `).join('');
            },
            switchTab(tab) {
                AudioEngine.click();
                State.activeTab = tab;
                this.renderNav();
                this.renderContent();
            },
            renderContent() {
                const container = document.getElementById('app-content');
                container.innerHTML = ''; // Clear
                container.className = "flex-grow max-w-7xl w-full mx-auto p-4 md:p-8 flex flex-col gap-6 fade-in";
                
                // Stop any running game loops
                if(window.gameAnimationFrame) cancelAnimationFrame(window.gameAnimationFrame);

                switch(State.activeTab) {
                    case 'Flashcards': Tabs.Flashcards(container); break;
                    case 'Reading': Tabs.Reading(container); break;
                    case 'Story Quiz': Tabs.StoryQuiz(container); break;
                    case 'Sentences': Tabs.Sentences(container); break;
                    case 'Fill Blanks': Tabs.FillBlanks(container); break;
                    case 'Words': Tabs.Words(container); break;
                    case 'Grammar': Tabs.Grammar(container); break;
                    case 'Dictation': Tabs.Dictation(container); break;
                    case 'Speaking': Tabs.Speaking(container); break;
                    case 'Writing': Tabs.Writing(container); break;
                    case 'Game': Tabs.Game(container); break;
                    case 'Leaderboard': Tabs.Leaderboard(container); break;
                }
            }
        };

        // ==========================================
        // 4. TAB IMPLEMENTATIONS
        // ==========================================
        const Tabs = {
            Flashcards(container) {
                const themes = Object.keys(vocabulary);
                // Add Custom theme if words exist
                if (State.customWords.length > 0 && !themes.includes("Custom Words")) {
                    themes.push("Custom Words");
                    vocabulary["Custom Words"] = State.customWords;
                }

                let currentList = vocabulary[State.flashcardTheme];
                if(State.flashcardIndex >= currentList.length) State.flashcardIndex = 0;
                let wordObj = currentList[State.flashcardIndex];

                const html = `
                    <div class="glass p-6 rounded-2xl flex flex-col gap-4">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-cinzel text-gold-gradient">Thematic Flashcards</h2>
                            <select id="theme-select" class="glass-gold text-white p-2 rounded outline-none cursor-pointer" style="background:#0f172a;">
                                ${themes.map(t => `<option value="${t}" ${t === State.flashcardTheme ? 'selected' : ''}>${t}</option>`).join('')}
                            </select>
                        </div>
                        <p class="text-gray-300">Master vocabulary by theme. Click the card to flip and see the French translation.</p>
                        
                        <div class="relative w-full max-w-md mx-auto h-64 perspective-1000 mt-4 cursor-pointer" onclick="this.querySelector('.flip-card-inner').classList.toggle('rotate-y-180'); AudioEngine.click();">
                            <div class="flip-card-inner relative w-full h-full transform-style-3d shadow-xl rounded-2xl">
                                <!-- Front -->
                                <div class="absolute w-full h-full backface-hidden glass-gold flex flex-col justify-center items-center p-6 text-center rounded-2xl border-2 border-gold-500">
                                    <h3 class="text-4xl font-bold text-white mb-4 drop-shadow-md">${wordObj.en}</h3>
                                    <p class="text-lg text-gray-200 italic">"${wordObj.sentence}"</p>
                                </div>
                                <!-- Back -->
                                <div class="absolute w-full h-full backface-hidden glass flex flex-col justify-center items-center p-6 text-center rounded-2xl border-2 border-blue-400 rotate-y-180 bg-blue-900">
                                    <h3 class="text-4xl font-bold text-gold-400 mb-4">${wordObj.fr}</h3>
                                    <p class="text-sm text-gray-300">Translation</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-center gap-4 mt-6">
                            <button id="prev-card" class="px-6 py-2 glass hover:bg-white/10 rounded-full font-bold">&larr; Prev</button>
                            <span class="py-2 text-gray-400">${State.flashcardIndex + 1} / ${currentList.length}</span>
                            <button id="next-card" class="px-6 py-2 glass hover:bg-white/10 rounded-full font-bold">Next &rarr;</button>
                        </div>
                    </div>

                    <!-- Custom Upload Section -->
                    <div class="glass p-6 rounded-2xl mt-4">
                        <h3 class="text-xl font-cinzel text-gold-gradient mb-2">Upload Custom Words</h3>
                        <p class="text-sm text-gray-300 mb-4">Add your own words. Format: <code>English, French, Sentence(optional)</code> separated by new lines.</p>
                        <textarea id="custom-upload-text" rows="4" placeholder="Apple, Pomme, I eat an apple.&#10;Car, Voiture"></textarea>
                        <button id="save-custom" class="mt-4 px-6 py-2 bg-gold-gradient text-blue-950 font-bold rounded-lg hover:opacity-90 transition">Save Words</button>
                    </div>
                `;
                container.innerHTML = html;

                document.getElementById('theme-select').addEventListener('change', (e) => {
                    State.flashcardTheme = e.target.value;
                    State.flashcardIndex = 0;
                    UI.renderContent();
                });

                document.getElementById('prev-card').addEventListener('click', () => {
                    State.flashcardIndex = (State.flashcardIndex - 1 + currentList.length) % currentList.length;
                    UI.renderContent();
                });
                document.getElementById('next-card').addEventListener('click', () => {
                    State.flashcardIndex = (State.flashcardIndex + 1) % currentList.length;
                    UI.renderContent();
                });

                document.getElementById('save-custom').addEventListener('click', () => {
                    const txt = document.getElementById('custom-upload-text').value;
                    if(!txt.trim()) return;
                    const lines = txt.split('\n');
                    let added = 0;
                    lines.forEach(line => {
                        const parts = line.split(',').map(s => s.trim());
                        if(parts.length >= 2) {
                            State.customWords.push({ en: parts[0], fr: parts[1], sentence: parts[2] || "" });
                            added++;
                        }
                    });
                    if(added > 0) {
                        Toast.show(`Added ${added} words! Select "Custom Words" theme.`);
                        vocabulary["Custom Words"] = State.customWords;
                        document.getElementById('custom-upload-text').value = '';
                        UI.renderContent();
                    } else {
                        Toast.show("Invalid format.", "error");
                    }
                });
            },

            Reading(container) {
                container.innerHTML = `
                    <div class="glass p-8 rounded-2xl flex flex-col gap-6 max-w-4xl mx-auto w-full">
                        <h2 class="text-3xl font-cinzel text-center text-gold-gradient">${storyData.title}</h2>
                        <div class="w-24 h-1 bg-gold-500 mx-auto rounded"></div>
                        <div class="text-lg leading-relaxed text-gray-200 space-y-6">
                            ${storyData.paragraphs.map(p => `<p class="p-4 glass-gold rounded-lg">${p}</p>`).join('')}
                        </div>
                    </div>
                `;
            },

            StoryQuiz(container) {
                let qIndex = 0;
                let score = 0;

                const renderQuestion = () => {
                    if (qIndex >= quizData.length) {
                        saveScore('quiz', score);
                        AudioEngine.win();
                        container.innerHTML = `
                            <div class="glass p-8 rounded-2xl text-center max-w-2xl mx-auto w-full">
                                <h2 class="text-3xl font-cinzel text-gold-gradient mb-4">Quiz Complete!</h2>
                                <p class="text-2xl mb-6">Your Score: <span class="font-bold text-gold-400">${score} / ${quizData.length}</span></p>
                                <button class="px-8 py-3 bg-gold-gradient text-blue-950 font-bold rounded-lg hover:opacity-90 transition" onclick="UI.switchTab('Leaderboard')">View Leaderboard</button>
                            </div>
                        `;
                        return;
                    }

                    const q = quizData[qIndex];
                    const progress = ((qIndex) / quizData.length) * 100;

                    container.innerHTML = `
                        <div class="glass p-8 rounded-2xl max-w-3xl mx-auto w-full flex flex-col gap-6">
                            <div class="flex justify-between items-center text-sm text-gray-400 font-bold">
                                <span>Question ${qIndex + 1} of ${quizData.length}</span>
                                <span>Score: ${score}</span>
                            </div>
                            <div class="w-full bg-white/10 h-2 rounded-full overflow-hidden">
                                <div class="bg-gold-500 h-full transition-all duration-300" style="width: ${progress}%"></div>
                            </div>
                            <h3 class="text-2xl font-cinzel">${q.q}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="quiz-opts">
                                ${q.opts.map((opt, i) => `
                                    <button class="glass p-4 rounded-xl text-left hover:bg-white/10 transition font-bold" data-idx="${i}">${opt}</button>
                                `).join('')}
                            </div>
                        </div>
                    `;

                    document.querySelectorAll('#quiz-opts button').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const selected = parseInt(e.target.dataset.idx);
                            document.querySelectorAll('#quiz-opts button').forEach(b => b.disabled = true);
                            
                            if (selected === q.ans) {
                                e.target.classList.add('bg-green-500/50', 'border-green-400');
                                AudioEngine.correct();
                                score++;
                            } else {
                                e.target.classList.add('bg-red-500/50', 'border-red-400');
                                document.querySelector(`[data-idx="${q.ans}"]`).classList.add('bg-green-500/50', 'border-green-400');
                                AudioEngine.wrong();
                            }
                            
                            setTimeout(() => {
                                qIndex++;
                                renderQuestion();
                            }, 1500);
                        });
                    });
                };
                renderQuestion();
            },

            Sentences(container) {
                let sIndex = 0;
                let currentWords = [];
                let answerWords = [];

                const loadSentence = () => {
                    if(sIndex >= sentencesData.length) sIndex = 0;
                    const original = sentencesData[sIndex];
                    // Clean punctuation for shuffling
                    const clean = original.replace(/[.,]/g, '');
                    currentWords = clean.split(' ').sort(() => Math.random() - 0.5);
                    answerWords = [];
                    render();
                };

                const render = () => {
                    container.innerHTML = `
                        <div class="glass p-8 rounded-2xl max-w-4xl mx-auto w-full">
                            <h2 class="text-2xl font-cinzel text-gold-gradient mb-2">Sentence Scramble</h2>
                            <p class="text-gray-300 mb-6">Click the words to build the correct sentence. (${sIndex + 1} / ${sentencesData.length})</p>
                            
                            <div class="min-h-[80px] p-4 glass-gold rounded-xl mb-6 flex flex-wrap gap-2 items-center" id="answer-box">
                                ${answerWords.length === 0 ? '<span class="text-gray-400 italic">Construct sentence here...</span>' : ''}
                                ${answerWords.map((w, i) => `<button class="px-4 py-2 bg-blue-900 border border-gold-400 rounded-lg font-bold shadow-lg" onclick="window.removeWord(${i})">${w}</button>`).join('')}
                            </div>
                            
                            <div class="flex flex-wrap gap-3 mb-6">
                                ${currentWords.map((w, i) => `<button class="px-4 py-2 glass hover:bg-white/10 rounded-lg font-bold transition" onclick="window.addWord(${i})">${w}</button>`).join('')}
                            </div>

                            <div class="flex justify-between">
                                <button class="px-6 py-2 glass hover:bg-white/10 rounded" onclick="window.skipSentence()">Skip</button>
                                <button class="px-6 py-2 bg-gold-gradient text-blue-950 font-bold rounded-lg" onclick="window.checkSentence()">Check Answer</button>
                            </div>
                        </div>
                    `;
                };

                window.addWord = (idx) => {
                    AudioEngine.click();
                    answerWords.push(currentWords.splice(idx, 1)[0]);
                    render();
                };
                window.removeWord = (idx) => {
                    AudioEngine.click();
                    currentWords.push(answerWords.splice(idx, 1)[0]);
                    render();
                };
                window.skipSentence = () => { sIndex++; loadSentence(); };
                window.checkSentence = () => {
                    const original = sentencesData[sIndex].replace(/[.,]/g, '').toLowerCase();
                    const attempt = answerWords.join(' ').toLowerCase();
                    if(attempt === original) {
                        AudioEngine.correct();
                        Toast.show("Excellent!");
                        setTimeout(() => { sIndex++; loadSentence(); }, 1000);
                    } else {
                        AudioEngine.wrong();
                        Toast.show("Not quite right, try again.", "error");
                    }
                };

                loadSentence();
            },

            FillBlanks(container) {
                let level = 0;
                let selectedBankWord = null;

                const render = () => {
                    if(level >= clozeData.length) {
                        container.innerHTML = `<div class="glass p-8 rounded text-center"><h2 class="text-2xl text-gold-400">All levels complete!</h2></div>`;
                        return;
                    }
                    const data = clozeData[level];
                    
                    // Replace blanks with interactive spans
                    let textHtml = data.text;
                    data.blanks.forEach((b, i) => {
                        textHtml = textHtml.replace('___', `<span class="inline-block min-w-[80px] border-b-2 border-gold-500 mx-2 text-center cursor-pointer text-gold-300 font-bold" data-blank="${i}" onclick="window.fillBlank(${i})">&nbsp;</span>`);
                    });

                    container.innerHTML = `
                        <div class="glass p-8 rounded-2xl max-w-3xl mx-auto w-full">
                            <h2 class="text-2xl font-cinzel text-gold-gradient mb-6">Fill in the Blanks (Level ${level + 1})</h2>
                            
                            <div class="text-xl leading-loose mb-8 bg-black/20 p-6 rounded-xl border border-white/10">
                                ${textHtml}
                            </div>

                            <h3 class="text-sm text-gray-400 mb-2 uppercase tracking-wide">Word Bank (Click to select)</h3>
                            <div class="flex flex-wrap gap-3 mb-6">
                                ${data.bank.map(w => `
                                    <button class="px-5 py-2 glass rounded-lg font-bold transition ${selectedBankWord === w ? 'bg-gold-500/30 border-gold-400' : 'hover:bg-white/10'}" 
                                        onclick="window.selectBankWord('${w}')">${w}</button>
                                `).join('')}
                            </div>
                            
                            <button class="w-full py-3 bg-gold-gradient text-blue-950 font-bold rounded-lg mt-4" onclick="window.checkCloze()">Submit Answer</button>
                        </div>
                    `;
                };

                window.selectBankWord = (w) => { AudioEngine.click(); selectedBankWord = w; render(); };
                window.fillBlank = (idx) => {
                    if(!selectedBankWord) return;
                    AudioEngine.click();
                    const blankEl = document.querySelector(`span[data-blank="${idx}"]`);
                    blankEl.innerText = selectedBankWord;
                    selectedBankWord = null; // deselect
                    render();
                    // manually update the DOM since render re-creates it. Better to just update DOM directly here.
                    document.querySelector(`span[data-blank="${idx}"]`).innerText = blankEl.innerText; 
                };
                
                // Override fillBlank to avoid re-render
                window.fillBlank = (idx) => {
                    if(!selectedBankWord) { Toast.show("Select a word from the bank first!", "error"); return; }
                    AudioEngine.click();
                    const blankEl = document.querySelector(`span[data-blank="${idx}"]`);
                    blankEl.innerText = selectedBankWord;
                    blankEl.classList.remove('border-gold-500');
                    blankEl.classList.add('border-green-500');
                    selectedBankWord = null;
                    render(); // Re-render to clear selection styling, but we need state for filled blanks.

                };

                // Let's refactor FillBlanks to hold state
                let filledState = {};
                const robustRender = () => {
                    if(level >= clozeData.length) {
                        container.innerHTML = `<div class="glass p-8 rounded text-center"><h2 class="text-2xl text-gold-400">All levels complete!</h2></div>`;
                        return;
                    }
                    const data = clozeData[level];
                    let textHtml = data.text;
                    data.blanks.forEach((b, i) => {
                        const val = filledState[i] || '&nbsp;';
                        textHtml = textHtml.replace('___', `<span class="inline-block min-w-[80px] border-b-2 border-gold-500 mx-2 text-center cursor-pointer text-gold-300 font-bold bg-white/5 px-2 rounded" data-blank="${i}" onclick="window.doFill(${i})">${val}</span>`);
                    });

                    container.innerHTML = `
                        <div class="glass p-8 rounded-2xl max-w-3xl mx-auto w-full">
                            <h2 class="text-2xl font-cinzel text-gold-gradient mb-6">Fill in the Blanks (Level ${level + 1})</h2>
                            <div class="text-xl leading-loose mb-8 bg-black/20 p-6 rounded-xl border border-white/10">${textHtml}</div>
                            <h3 class="text-sm text-gray-400 mb-2 uppercase tracking-wide">Word Bank (Click to select)</h3>
                            <div class="flex flex-wrap gap-3 mb-6">
                                ${data.bank.map(w => `
                                    <button class="px-5 py-2 glass rounded-lg font-bold transition ${selectedBankWord === w ? 'bg-gold-500 border-gold-400 text-blue-900' : 'hover:bg-white/10'}" 
                                        onclick="window.selBank('${w}')">${w}</button>
                                `).join('')}
                            </div>
                            <button class="w-full py-3 bg-gold-gradient text-blue-950 font-bold rounded-lg mt-4" onclick="window.chkCloze()">Check Answer</button>
                        </div>
                    `;
                }

                window.selBank = (w) => { AudioEngine.click(); selectedBankWord = w; robustRender(); };
                window.doFill = (i) => { 
                    if(!selectedBankWord) return;
                    AudioEngine.click();
                    filledState[i] = selectedBankWord;
                    selectedBankWord = null;
                    robustRender();
                };
                window.chkCloze = () => {
                    const data = clozeData[level];
                    let correct = true;
                    data.blanks.forEach((b, i) => {
                        if(filledState[i] !== b) correct = false;
                    });
                    if(correct) {
                        AudioEngine.correct();
                        Toast.show("Perfect!");
                        level++;
                        filledState = {};
                        setTimeout(robustRender, 1000);
                    } else {
                        AudioEngine.wrong();
                        Toast.show("Some answers are incorrect.", "error");
                    }
                };

                robustRender();
            },

            Words(container) {
                // Generate a dynamic word bank from the thematic vocabulary
                const wordBank = [];
                for (let t in vocabulary) {
                    vocabulary[t].forEach(item => {
                        // Only add single words (no spaces/hyphens) for a clean scramble game
                        if (!item.en.includes(' ') && !item.en.includes('-') && !item.en.includes('(')) {
                            wordBank.push({ word: item.en.toLowerCase(), theme: t });
                        }
                    });
                }

                let currentItem = null;
                let scrambled = "";
                
                const loadWord = () => {
                    currentItem = wordBank[Math.floor(Math.random() * wordBank.length)];
                    scrambled = currentItem.word.split('').sort(() => Math.random() - 0.5).join('');
                    
                    // ensure it's actually scrambled
                    if(scrambled === currentItem.word && currentItem.word.length > 1) {
                        scrambled = currentItem.word.split('').reverse().join('');
                    }
                    render();
                };

                const render = () => {
                    container.innerHTML = `
                        <div class="glass p-8 rounded-2xl max-w-xl mx-auto w-full text-center">
                            <h2 class="text-2xl font-cinzel text-gold-gradient mb-2">Word Scramble</h2>
                            <p class="text-gray-400 mb-2">Unscramble the letters to find the hidden word.</p>
                            
                            <!-- Theme Hint -->
                            <p class="text-sm font-bold text-gold-500 bg-white/5 inline-block px-4 py-1 rounded-full mb-8 border border-gold-500/30">
                                Hint (Theme): ${currentItem.theme}
                            </p>
                            
                            <div class="text-5xl font-bold tracking-[0.5em] text-white mb-8 drop-shadow-lg uppercase">${scrambled}</div>
                            
                            <input type="text" id="word-input" class="text-center text-2xl uppercase tracking-widest mb-4" placeholder="TYPE HERE" autocomplete="off">
                            
                            <div class="flex gap-4 justify-center">
                                <button class="px-6 py-2 glass text-gold-300 rounded hover:bg-white/10" onclick="window.hintWord()">Letter Hint</button>
                                <button class="px-8 py-2 bg-gold-gradient text-blue-950 font-bold rounded hover:opacity-90 transition" onclick="window.checkWord()">Submit</button>
                            </div>
                        </div>
                    `;
                    document.getElementById('word-input').addEventListener('keypress', (e) => {
                        if(e.key === 'Enter') window.checkWord();
                    });
                };

                window.hintWord = () => {
                    AudioEngine.click();
                    Toast.show(`Starts with: ${currentItem.word.substring(0, 2).toUpperCase()}`);
                };

                window.checkWord = () => {
                    const input = document.getElementById('word-input').value.toLowerCase().trim();
                    if(input === currentItem.word) {
                        AudioEngine.correct();
                        Toast.show("Correct!");
                        setTimeout(loadWord, 1000);
                    } else {
                        AudioEngine.wrong();
                        Toast.show("Try again", "error");
                    }
                };

                loadWord();
            },

            Grammar(container) {
                let gIndex = 0;
                let step = 1; // 1: find past, 2: match present

                const render = () => {
                    if(gIndex >= grammarData.length) gIndex = 0;
                    const data = grammarData[gIndex];

                    if(step === 1) {
                        const words = data.s.split(' ');
                        const sentenceHtml = words.map(w => `<span class="inline-block mx-1 border-b border-transparent hover:border-gold-500 cursor-pointer transition text-2xl" onclick="window.checkPast('${w.replace(/[.,]/g,'')}')">${w}</span>`).join('');

                        container.innerHTML = `
                            <div class="glass p-8 rounded-2xl max-w-2xl mx-auto w-full text-center">
                                <h2 class="text-2xl font-cinzel text-gold-gradient mb-2">Tense Tracker - Scout</h2>
                                <p class="text-gray-300 mb-8">Step 1: Click the word that is a <b>Past Tense Verb</b>.</p>
                                <div class="p-6 glass-gold rounded-xl leading-relaxed">${sentenceHtml}</div>
                            </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <div class="glass p-8 rounded-2xl max-w-2xl mx-auto w-full text-center fade-in">
                                <h2 class="text-2xl font-cinzel text-gold-gradient mb-2">Tense Tracker - Match</h2>
                                <p class="text-gray-300 mb-8">Step 2: What is the present form of <span class="text-gold-400 font-bold text-xl uppercase">${data.past}</span>?</p>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    ${data.present.map((opt, i) => `
                                        <button class="glass p-4 rounded-xl text-lg font-bold hover:bg-gold-500/20 transition" onclick="window.checkPresent(${i})">${opt}</button>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                };

                window.checkPast = (w) => {
                    const data = grammarData[gIndex];
                    if(w.toLowerCase() === data.past.toLowerCase()) {
                        AudioEngine.correct();
                        step = 2;
                        render();
                    } else {
                        AudioEngine.wrong();
                        Toast.show("That's not the past tense verb.", "error");
                    }
                };

                window.checkPresent = (idx) => {
                    const data = grammarData[gIndex];
                    if(idx === data.ans) {
                        AudioEngine.correct();
                        Toast.show("Great job!");
                        gIndex++;
                        step = 1;
                        setTimeout(render, 1000);
                    } else {
                        AudioEngine.wrong();
                        Toast.show("Incorrect present form.", "error");
                    }
                };

                render();
            },

            Dictation(container) {
                // Flatten all vocab words for dictation
                const allVocab = [];
                for(let k in vocabulary) allVocab.push(...vocabulary[k]);
                
                let currentVocabIndex = Math.floor(Math.random() * allVocab.length);
                let playbackRate = 0.85;
                const rates = [0.5, 0.85, 1.0, 1.2];

                const render = () => {
                    container.innerHTML = `
                        <div class="glass p-8 rounded-2xl max-w-xl mx-auto w-full text-center">
                            <h2 class="text-2xl font-cinzel text-gold-gradient mb-4">Dictation</h2>
                            <p class="text-gray-300 mb-6">Listen carefully and type the vocabulary word you hear.</p>
                            
                            <div class="flex justify-center gap-4 mb-8 items-center">
                                <button id="speed-btn" class="px-4 py-2 glass-gold rounded-lg font-bold text-sm w-28 hover:bg-white/10 transition" onclick="window.toggleSpeed()">
                                    Speed: ${playbackRate}x
                                </button>
                                
                                <button class="w-24 h-24 rounded-full bg-gold-gradient flex items-center justify-center hover:scale-105 transition shadow-[0_0_20px_rgba(251,191,36,0.5)]" onclick="window.playAudio()">
                                    <svg width="40" height="40" viewBox="0 0 24 24" fill="#0f172a"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                </button>
                                
                                <button class="px-4 py-2 glass-gold rounded-lg font-bold text-sm w-28 hover:bg-white/10 transition" onclick="window.spellAudio()">
                                    Spell It
                                </button>
                            </div>
                            
                            <input type="text" id="dict-input" placeholder="TYPE THE WORD..." class="mb-6 text-center text-2xl tracking-widest uppercase p-4" autocomplete="off">
                            
                            <button class="w-full py-3 glass hover:bg-white/10 rounded-lg font-bold" onclick="window.checkDict()">Check Answer</button>
                        </div>
                    `;
                    
                    // Allow pressing Enter to submit
                    document.getElementById('dict-input').addEventListener('keypress', (e) => {
                        if(e.key === 'Enter') window.checkDict();
                    });
                };

                window.toggleSpeed = () => {
                    AudioEngine.click();
                    let idx = rates.indexOf(playbackRate);
                    playbackRate = rates[(idx + 1) % rates.length];
                    document.getElementById('speed-btn').innerText = `Speed: ${playbackRate}x`;
                };

                window.playAudio = () => {
                    AudioEngine.click();
                    window.speechSynthesis.cancel(); // CRITICAL FIX: Clears the audio queue to prevent it from getting stuck/silent
                    const text = allVocab[currentVocabIndex].en;
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'en-US'; // Forced constraint
                    utterance.rate = playbackRate;
                    window.speechSynthesis.speak(utterance);
                };

                window.spellAudio = () => {
                    AudioEngine.click();
                    window.speechSynthesis.cancel(); // CRITICAL FIX: Clears the audio queue
                    const word = allVocab[currentVocabIndex].en;
                    // Join characters with commas to force a clear pause between letters
                    const spelledText = word.split('').join(', ');
                    const utterance = new SpeechSynthesisUtterance(spelledText);
                    utterance.lang = 'en-US';
                    utterance.rate = playbackRate * 0.8; 
                    window.speechSynthesis.speak(utterance);
                };

                window.checkDict = () => {
                    const input = document.getElementById('dict-input').value.toLowerCase().replace(/[.,]/g, '').trim();
                    const target = allVocab[currentVocabIndex].en.toLowerCase().replace(/[.,]/g, '').trim();
                    
                    if(input === target) {
                        AudioEngine.correct();
                        Toast.show("Perfect listening!");
                        currentVocabIndex = Math.floor(Math.random() * allVocab.length);
                        setTimeout(render, 1500);
                    } else {
                        AudioEngine.wrong();
                        Toast.show("Not quite a match. Listen again.", "error");
                    }
                };

                render();
            },

            Speaking(container) {
                container.innerHTML = `
                    <div class="glass p-8 rounded-2xl max-w-3xl mx-auto w-full">
                        <h2 class="text-2xl font-cinzel text-gold-gradient mb-6 text-center">Speaking Practice</h2>
                        <div class="flex flex-col gap-4">
                            ${speakingPrompts.map((p, i) => `
                                <div class="glass-gold rounded-xl overflow-hidden">
                                    <button class="w-full p-4 text-left font-bold text-lg flex justify-between items-center bg-white/5 hover:bg-white/10 transition" onclick="document.getElementById('sq-${i}').classList.toggle('hidden'); AudioEngine.click();">
                                        ${p.p}
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                    </button>
                                    <div id="sq-${i}" class="hidden p-4 bg-black/20 border-t border-white/10">
                                        <p class="text-sm text-gold-300 mb-2 uppercase tracking-wider">Guiding Questions:</p>
                                        <ul class="list-disc list-inside text-gray-200 space-y-1">
                                            ${p.q.map(q => `<li>${q}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            Writing(container) {
                const savedLog = localStorage.getItem('esl_writing_log') || '';
                container.innerHTML = `
                    <div class="glass p-8 rounded-2xl max-w-4xl mx-auto w-full h-full flex flex-col">
                        <h2 class="text-2xl font-cinzel text-gold-gradient mb-2">Writing Journal</h2>
                        <p class="text-gray-300 mb-4">Write a short paragraph using the new vocabulary. Your progress is saved locally.</p>
                        <textarea id="journal-entry" class="flex-grow min-h-[300px] text-lg p-6 bg-black/20 border-white/20 resize-none leading-loose" placeholder="Dear journal...">${savedLog}</textarea>
                        <div class="flex justify-end mt-4 gap-4">
                            <button class="px-6 py-2 glass rounded hover:bg-red-500/20 text-red-300 transition" onclick="document.getElementById('journal-entry').value=''; localStorage.removeItem('esl_writing_log');">Clear</button>
                            <button class="px-8 py-2 bg-gold-gradient text-blue-950 font-bold rounded shadow-lg hover:scale-105 transition" onclick="window.saveJournal()">Save Entry</button>
                        </div>
                    </div>
                `;

                window.saveJournal = () => {
                    AudioEngine.click();
                    const val = document.getElementById('journal-entry').value;
                    localStorage.setItem('esl_writing_log', val);
                    Toast.show("Journal saved successfully!");
                };
            },

            Game(container) {
                const themes = Object.keys(vocabulary);
                
                // Word Catcher Game
                container.innerHTML = `
                    <div class="glass p-6 rounded-2xl w-full text-center flex flex-col items-center flex-grow">
                        <h2 class="text-3xl font-cinzel text-gold-gradient mb-2">Word Catcher</h2>
                        <p class="text-gray-300 mb-4">Catch the correct English translation for the French word! Use Mouse or Touch.</p>
                        
                        <div class="flex flex-wrap gap-4 mb-4 justify-center w-full max-w-4xl">
                            <select id="game-theme" class="glass-gold text-white p-2 rounded outline-none cursor-pointer" style="background:#0f172a;">
                                <option value="All">All Themes</option>
                                ${themes.map(t => `<option value="${t}">${t}</option>`).join('')}
                            </select>
                            <select id="game-speed" class="glass-gold text-white p-2 rounded outline-none cursor-pointer" style="background:#0f172a;">
                                <option value="0.8">Speed: Slow</option>
                                <option value="1.5" selected>Speed: Normal</option>
                                <option value="2.5">Speed: Fast</option>
                                <option value="4.0">Speed: Expert</option>
                            </select>
                        </div>
                        
                        <div id="game-container" class="w-full max-w-5xl bg-blue-950 rounded-xl overflow-hidden relative flex-grow min-h-[50vh]" style="touch-action: none;">
                            <canvas id="gameCanvas" class="border-none w-full h-full block"></canvas>
                            
                            <!-- Overlay -->
                            <div id="game-overlay" class="absolute inset-0 bg-black/80 flex flex-col justify-center items-center backdrop-blur-sm z-10">
                                <h3 class="text-3xl text-gold-400 font-cinzel mb-4">Ready?</h3>
                                <button class="px-8 py-3 bg-gold-gradient text-blue-950 font-bold rounded-lg text-xl" onclick="window.startGame()">Start Game</button>
                            </div>
                        </div>
                        <div class="flex justify-between w-full max-w-5xl mt-4 font-bold text-xl px-4">
                            <div>Score: <span id="game-score" class="text-gold-400">0</span></div>
                            <div>Lives: <span id="game-lives" class="text-red-400">❤️❤️❤️</span></div>
                        </div>
                    </div>
                `;

                const canvas = document.getElementById('gameCanvas');
                const ctx = canvas.getContext('2d');
                const gameContainer = document.getElementById('game-container');
                let score = 0;
                let lives = 3;
                let isPlaying = false;
                
                // Game state
                let targetPair = {};
                let fallingWords = [];
                let playerX = 300;
                const playerWidth = 120; // Made the bucket a bit wider
                const playerHeight = 20;

                // Flatten vocab for "All Themes" fallback
                const allVocab = [];
                for(let k in vocabulary) allVocab.push(...vocabulary[k]);
                let activeVocab = allVocab;

                const getNewTarget = () => {
                    const selectedTheme = document.getElementById('game-theme').value;
                    activeVocab = selectedTheme === 'All' ? allVocab : (vocabulary[selectedTheme] || allVocab);
                    
                    if (activeVocab.length === 0) activeVocab = allVocab; // Fallback just in case
                    targetPair = activeVocab[Math.floor(Math.random() * activeVocab.length)];
                };

                const spawnWord = () => {
                    // Check if a correct word is already falling to prevent flooding
                    const hasCorrectOnScreen = fallingWords.some(w => w.isCorrect);
                    const correctChance = hasCorrectOnScreen ? 0.1 : 0.4; 
                    const isCorrect = Math.random() < correctChance;
                    
                    let text = targetPair.en;
                    if(!isCorrect) {
                        let wrongTarget = activeVocab[Math.floor(Math.random() * activeVocab.length)];
                        text = wrongTarget.en;
                    }
                    
                    const baseSpeed = parseFloat(document.getElementById('game-speed').value);
                    fallingWords.push({
                        x: Math.random() * (canvas.width - 150) + 75,
                        y: 0,
                        text: text,
                        speed: baseSpeed + (Math.random() * baseSpeed * 0.5), // Adds natural speed variance
                        isCorrect: isCorrect
                    });
                };

                window.startGame = () => {
                    AudioEngine.click();
                    document.getElementById('game-overlay').style.display = 'none';
                    
                    // Match canvas internal resolution to its HTML container block
                    canvas.width = gameContainer.clientWidth;
                    canvas.height = gameContainer.clientHeight;
                    playerX = canvas.width / 2;
                    
                    score = 0;
                    lives = 3;
                    fallingWords = [];
                    isPlaying = true;
                    getNewTarget();
                    document.getElementById('game-score').innerText = score;
                    document.getElementById('game-lives').innerText = '❤️'.repeat(lives);
                    gameLoop();
                };

                const drawPlayer = () => {
                    ctx.fillStyle = '#fbbf24'; // Gold
                    ctx.beginPath();
                    ctx.moveTo(playerX - playerWidth/2, canvas.height - playerHeight);
                    ctx.lineTo(playerX + playerWidth/2, canvas.height - playerHeight);
                    ctx.lineTo(playerX + playerWidth/2 - 15, canvas.height);
                    ctx.lineTo(playerX - playerWidth/2 + 15, canvas.height);
                    ctx.fill();
                };

                const gameLoop = () => {
                    if(!isPlaying) return;
                    
                    // Seamlessly resize canvas if the window shape changes
                    if (canvas.width !== gameContainer.clientWidth || canvas.height !== gameContainer.clientHeight) {
                        canvas.width = gameContainer.clientWidth;
                        canvas.height = gameContainer.clientHeight;
                    }
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    // Draw Target French Word (Prompt)
                    ctx.fillStyle = 'rgba(255,255,255,0.2)';
                    ctx.font = 'bold 48px Cinzel, serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(targetPair.fr, canvas.width/2, 80);

                    // Rate of spawning based on speed setting
                    const baseSpeed = parseFloat(document.getElementById('game-speed').value);
                    const spawnRate = 0.015 * (baseSpeed / 1.5); 
                    if(Math.random() < Math.min(spawnRate, 0.05)) spawnWord();

                    // Logic & Draw words
                    for(let i = fallingWords.length - 1; i >= 0; i--) {
                        let fw = fallingWords[i];
                        fw.y += fw.speed;

                        ctx.font = 'bold 22px Arial';
                        ctx.textAlign = 'center';
                        
                        // Dynamically measure text width to draw the background box
                        const textMetrics = ctx.measureText(fw.text);
                        const boxWidth = Math.max(textMetrics.width + 40, 100);
                        
                        // Draw falling word box
                        ctx.fillStyle = 'rgba(30, 58, 138, 0.9)';
                        ctx.fillRect(fw.x - boxWidth/2, fw.y - 25, boxWidth, 36);
                        ctx.strokeStyle = '#fbbf24';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(fw.x - boxWidth/2, fw.y - 25, boxWidth, 36);
                        
                        ctx.fillStyle = 'white';
                        ctx.fillText(fw.text, fw.x, fw.y);

                        // Collision detection
                        if(fw.y > canvas.height - playerHeight && fw.y < canvas.height) {
                            if(Math.abs(fw.x - playerX) < playerWidth/2 + boxWidth/2 - 10) {
                                // Caught
                                if(fw.isCorrect) {
                                    AudioEngine.correct();
                                    score += 10;
                                    getNewTarget();
                                } else {
                                    AudioEngine.wrong();
                                }
                                fallingWords.splice(i, 1);
                                document.getElementById('game-score').innerText = score;
                                document.getElementById('game-lives').innerText = '❤️'.repeat(lives);
                                continue;
                            }
                        }

                        // Off screen
                        if(fw.y > canvas.height) {
                            if(fw.isCorrect) {
                                // missed correct word
                                lives--;
                                AudioEngine.wrong();
                                document.getElementById('game-lives').innerText = '❤️'.repeat(lives);
                            }
                            fallingWords.splice(i, 1);
                        }
                    }

                    drawPlayer();

                    if(lives <= 0) {
                        isPlaying = false;
                        saveScore('game', score);
                        AudioEngine.wrong(); // distinct game over sound
                        document.getElementById('game-overlay').style.display = 'flex';
                        document.getElementById('game-overlay').innerHTML = `
                            <h3 class="text-4xl text-red-500 font-cinzel mb-4 drop-shadow-lg">Game Over</h3>
                            <p class="text-2xl text-white mb-6">Final Score: <span class="text-gold-400">${score}</span></p>
                            <button class="px-8 py-3 bg-gold-gradient text-blue-950 font-bold rounded-lg text-xl hover:opacity-90 transition" onclick="window.startGame()">Play Again</button>
                        `;
                        return;
                    }

                    window.gameAnimationFrame = requestAnimationFrame(gameLoop);
                };

                // Controls
                const updateMouse = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    let x = clientX - rect.left;
                    // scale x to canvas resolution accurately
                    x = (x / rect.width) * canvas.width;
                    
                    if(x < playerWidth/2) x = playerWidth/2;
                    if(x > canvas.width - playerWidth/2) x = canvas.width - playerWidth/2;
                    playerX = x;
                };

                canvas.addEventListener('mousemove', updateMouse);
                canvas.addEventListener('touchmove', (e) => { e.preventDefault(); updateMouse(e); }, {passive: false});
            },

            Leaderboard(container) {
                const s = State.scores;
                container.innerHTML = `
                    <div class="glass p-8 rounded-2xl max-w-2xl mx-auto w-full text-center">
                        <div class="inline-block p-4 rounded-full bg-gold-gradient/20 mb-4 animate-float">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>
                        </div>
                        <h2 class="text-3xl font-cinzel text-gold-gradient mb-8">Hall of Fame</h2>
                        
                        <div class="space-y-4">
                            <div class="glass-gold p-4 rounded-xl flex justify-between items-center border border-gold-500/30">
                                <span class="text-xl font-bold">Story Quiz Top Score</span>
                                <span class="text-2xl text-gold-400 font-cinzel">${s.quiz}</span>
                            </div>
                            <div class="glass-gold p-4 rounded-xl flex justify-between items-center border border-gold-500/30">
                                <span class="text-xl font-bold">Word Catcher Top Score</span>
                                <span class="text-2xl text-gold-400 font-cinzel">${s.game}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        };

        // ==========================================
        // 5. INITIALIZATION
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            UI.init();
        });

    </script>
</body>
</html>
